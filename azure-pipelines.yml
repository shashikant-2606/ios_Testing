trigger:
  - main

pool:
  vmImage: 'macOS-latest'

stages:
  - stage: emulator
    jobs:
      - job: test
        steps:
          - task: NodeTool@0
            inputs:
              versionSource: 'spec'
              versionSpec: '18.17.1'

          - task: JavaToolInstaller@0
            inputs:
              versionSpec: '11'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'


          - script: |
              xcrun simctl create "MySimulatorName" "iPhone 12" "iOS 15.0"
              xcrun simctl list devices
              xcrun simctl boot "MySimulatorName"
              npm install -g appium
              appium driver install xcuitest
              appium plugin install --source npm appium-device-farm
              appium --address 0.0.0.0 --port 4723 --log-level debug --use-plugins appium-xcuitest-driver &
              
              
  
          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.11'
              mavenVersionOption: 'Default'
              mavenAuthenticateFeed: true
              effectivePomSkip: true
              sonarQubeRunAnalysis: true
              sqMavenPluginVersionChoice: 'latest'
              
          - task: CopyFiles@2
            displayName: 'Copy failure screenshots and test logs'
            inputs:
              SourceFolder: '$(Build.SourcesDirectory)/target'
              Contents: |
                     surefire-reports/failure_screenshots/*.png
                     log/*.log
              TargetFolder: '$(Build.ArtifactStagingDirectory)'
            condition: succeededOrFailed()
            
          - task: PublishBuildArtifacts@1
            displayName: 'Publish copied artifacts'
            inputs:
                PathtoPublish: '$(Build.ArtifactStagingDirectory)'
                ArtifactName: 'drop'
                publishLocation: 'Container'
            condition: succeededOrFailed()